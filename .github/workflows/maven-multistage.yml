name: Maven Package - Multi stage docker

on: workflow_dispatch

jobs:

  build:
  
    runs-on: ubuntu-latest
    
#     outputs:
#       jar_version: ${{ steps.bump.outputs.jar_version }}

    steps:
    - uses: actions/checkout@v3
    - name: upgrade patch version
      run: mvn build-helper:parse-version versions:set -DnewVersion=\${parsedVersion.majorVersion}.\${parsedVersion.minorVersion}.\${parsedVersion.nextIncrementalVersion} versions:commit
    - name: set version variable
      run: echo VERSION=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.version -q -DforceStdout) >> $GITHUB_ENV
    - name: set artifact name
      run: echo ARTIFACT=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.artifactId -q -DforceStdout) >> $GITHUB_ENV
    - name: set fullname
      run: echo FULLNAME="${{ env.ARTIFACT }}-${{ env.VERSION }}" >> $GITHUB_ENV

    
     

#     - name: Bump jar version
#       id: bump
#       run: |
#         POMPATH=$(git rev-parse --show-toplevel)
#         OLD_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
#         BUMP_MODE="none"
#         old="$OLD_VERSION"
#         parts=( ${old//./ } )
#         bv=$((parts[2] + 1))
#         NEW_VERSION="${parts[0]}.${parts[1]}.${bv}"
#         echo $parts
#         echo "pom.xml at" $POMPATH "will be bumped from" $OLD_VERSION "to" $NEW_VERSION 
#         mvn -q versions:set -DnewVersion="${NEW_VERSION}" --file $POMPATH/pom.xml
#         echo ::set-output name=jar_version::${NEW_VERSION}
        
#     - name: set artifact name
#       run: echo ARTIFACT="my-app-"${{ steps.bump.outputs.jar_version }} >> $GITHUB_ENV
    - name: Login to Docker Hub
      env:
        USERNAME: ${{ secrets.DOCKER_USERNAME }}
        PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
      run: |
        docker login -u $USERNAME -p $PASSWORD
    - name: Docker build
      run: docker build . --file Dockerfile --build-arg version=${{ env.VERSION }} --build-arg fullname=${{ env.FULLNAME }} --tag oralush49/or_repo:${{ env.VERSION }}
 #     run: docker build . --file Dockerfile --tag oralush49/or_repo:test
    - name: Docker push
      run: docker push oralush49/or_repo:${{ env.VERSION }}
